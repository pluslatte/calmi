# calmi Copilot Instructions
## Overview
- `src/main.rs` boots an axum 0.8.6 router with `AppState` and binds to `0.0.0.0:3000`; `Config::base_url` always uses https for ActivityPub compliance.
- HTTP layer lives under `src/app`: `routes.rs` wires `object_builders::*::endpoint_uri_template()` to handlers so update builder before exposing a new route.
- ActivityPub payloads are built via `calmi_activity_streams` (workspace crate) with serde-friendly structs; use the provided `SingleOrMultiple` helpers instead of ad-hoc JSON.
- Workspace also ships `calmi_webfinger` for WebFinger DTOs and `migration` for SeaORM migrations; keep versions in sync through `Cargo.toml`.
## HTTP Surface
- All ActivityPub responses must set `application/activity+json`; see handler patterns in `src/app/handlers/activity_pub/{person,note,outbox,create}.rs`.
- Inbox POSTs deserialize into `app::types::InboxActivity` using tagged enums (`type` field) and delegate to `object_receivers::activity_pub::inbox::*`; extend there for new activity types.
- WebFinger queries (`/.well-known/webfinger`) expect `acct:user@{Config.domain}` and reuse `object_builders::webfinger::build_webfinger_response`.
## Data Layer
- `domain::repositories::{user,note}` define the async traits; `storage::postgres::{user,note}` implement them with SeaORM 1.1.17 ActiveModels and must stay `Send + Sync`.
- Repository implementations always clone `PostgresStorage` (connection-pooled `DatabaseConnection`), so prefer extending via trait impls instead of introducing new storage structs.
- Configured schema tracks users and notes; align migrations in `migration/src` with entity structs generated by `sea-orm-cli`.
## Activity Builders
- `object_builders/activity_pub/*` return typed ActivityStreams structs and expose `endpoint_uri_template()` used in routing; add matching tests in `tests/` for each new builder.
- `build_create_activity` wraps `build_note`; maintain the invariant that IDs use `Config.base_url` and include the author username.
- The `calmi_activity_streams/macros::object_based` attribute injects shared ActivityStreams fields; reuse it when introducing new object structs.
## Testing & Local Dev
- Bring up Postgres via `docker compose up -d`; application expects `DATABASE_URL`, tests require `TEST_DATABASE_URL` pointing to the admin DB (see `tests/helper.rs`).
- Run migrations with `cargo run -p migration` or `sea-orm-cli migrate up`; tests auto-run migrations per database.
- Use `cargo test` (workspace targets Rust 2024 edition); HTTP tests rely on `axum-test` and stand up the router via `create_test_server`.
## Conventions
- Always pipe storage access through `AppState.storage`; handlers should stay thin orchestrators.
- Preserve HTTP logging style (stdout `println!`/stderr `eprintln!`) in inbox handlers until a structured logger is introduced.
- When adding endpoints, mirror the test patterns asserting headers and ActivityPub shape under `tests/` to prevent regressions.
